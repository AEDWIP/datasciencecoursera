---
title: 'Reproducible Research: Peer Assessment 2'
author: "Andrew E. Davidson"
date: "September 23, 2015"
output: html_document
---

## Download data and documentation, and load data 
```{r load data if needed}
fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
fileName <- "repdata-data-StormData.csv.bz2"
dataDir <- "data/"
dataFileZip <- sprintf("%s%s", dataDir, fileName)
dataFile <- sprintf("%s%s", dataDir, "repdata-data-StormData.csv")
if (!file.exists(dataDir)) { dir.create(dataDir)}
if (!file.exists(dataFile)) {
  download.file(fileURL, destfile=dataFileZip, method="curl")
  dateDownLoaded <- date()
  write(dateDownLoaded, file=sprintf("%s%s", dataDir, "dateDownLoaded.txt"))
  
  library(R.utils)
  bunzip2(dataFileZip)
}

fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf"
fileName <- "stormDataDocumentation.pdf"
docFile <- sprintf("%s%s", dataDir, fileName)
if (!file.exists(docFile)) {
  download.file(fileURL, destfile=docFile, method="curl")
}

fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf"
fileName <- "FAQ.pdf"
faqFile <- sprintf("%s%s", dataDir, fileName)
if (!file.exists(faqFile)) {
  download.file(fileURL, destfile=faqFile, method="curl")
}

library(data.table)
if (!exists("dTable")){
    # line 54 did not have two elements, fill should fix this for us
    csv <- read.csv(dataFile, header=TRUE, fill=TRUE)
    dTable <- data.table(csv)
}

#clean up. Temporarly turn off warnings about missing objects not found
options(warn=-1) 
rm(csv, dataDir, dataFile, dataFileZip, dateDownLoaded, docFile, faqFile, fileName, fileURL)
options(warn=0) 

```

## Question 1:
Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?




```{r use tables}
xx <- dTable[, list(EVTYPE, HARM = FATALITIES + INJURIES)]
yy <- xx[, list(TOTAL_HARM=sum(HARM)), by=EVTYPE]
zz <- yy[order(TOTAL_HARM, decreasing=TRUE),]
nrow(zz[TOTAL_HARM != 0])
```

```{r q1 graph}
library(ggplot2)
#bad q1Graph <- ggplot(zz[1:10,]) #, aes(factor(TOTAL_HARM))
# bad q1Graph + geom_bar()

# y axis is bad q1Graph <- qplot(factor(EVTYPE), data=zz[1:10,], geom="bar", fill=factor(EVTYPE))
# bad q1Graph <- qplot(y=TOTAL_HARM, x=factor(EVTYPE), data=zz[1:10,], geom="bar", fill=factor(EVTYPE))

# key has factor, and event type, one is black the other is color
#q1Graph <- qplot(y=TOTAL_HARM, x=factor(EVTYPE), factor(EVTYPE), colour=EVTYPE, data=zz[1:10,], geom="point", fill=factor(EVTYPE))

#q1Graph <- qplot(y=TOTAL_HARM, x=factor(EVTYPE), colour=EVTYPE, data=zz[1:10,], geom="point", fill=factor(EVTYPE))

# this graph is really close
#q1Graph <- qplot(y=TOTAL_HARM, x=EVTYPE, stat="identity",colour=EVTYPE, data=zz[1:10,], geom="bar", fill=factor(EVTYPE))

#q1Graph <- qplot(y=TOTAL_HARM, x=EVTYPE, stat="identity",data=zz[1:10,], geom="bar", fill=factor(EVTYPE))

q1Graph <- qplot(y=TOTAL_HARM, x=EVTYPE, stat="identity",data=zz[1:10,], geom="bar", fill=factor(EVTYPE), main="10 Most Harmfull Storm Types to Public Health")

q1Graph + theme(axis.text.x=element_blank())
zz[1:10,]
```

## AED hacks
length(unique(dTable[,EVTYPE]))
dt <- data.table(a=1:2, b=2:3, c=3:4)
dt[, (b, c)]

```{r q1: table is converted back to data frame}
x <- dTable[, list(EVTYPE,FATALITIES, INJURIES)]
y <- x[, list(EVTYPE, HARM=FATALITIES + INJURIES)]
a <- aggregate(. ~ EVTYPE, data=y, FUN=sum)
o <- a[order(a$HARM, decreasing=TRUE),]

# select events that have harmed people
h<-o[o$HARM != 0,]
nrow(h)
```
## Question 2:
Across the United States, which types of events have the greatest economic consequences?
