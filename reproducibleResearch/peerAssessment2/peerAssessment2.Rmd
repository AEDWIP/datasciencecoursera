---
title: 'Reproducible Research: Peer Assessment 2'
author: "Andrew E. Davidson"
date: "September 23, 2015"
output: html_document
---

## Download data and documentation, and load data 
```{r load data if needed}
fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
fileName <- "repdata-data-StormData.csv.bz2"
dataDir <- "data/"
dataFileZip <- sprintf("%s%s", dataDir, fileName)
dataFile <- sprintf("%s%s", dataDir, "repdata-data-StormData.csv")
if (!file.exists(dataDir)) { dir.create(dataDir)}
if (!file.exists(dataFile)) {
  download.file(fileURL, destfile=dataFileZip, method="curl")
  dateDownLoaded <- date()
  write(dateDownLoaded, file=sprintf("%s%s", dataDir, "dateDownLoaded.txt"))
  
  library(R.utils)
  bunzip2(dataFileZip)
}

fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf"
fileName <- "stormDataDocumentation.pdf"
docFile <- sprintf("%s%s", dataDir, fileName)
if (!file.exists(docFile)) {
  download.file(fileURL, destfile=docFile, method="curl")
}

fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf"
fileName <- "FAQ.pdf"
faqFile <- sprintf("%s%s", dataDir, fileName)
if (!file.exists(faqFile)) {
  download.file(fileURL, destfile=faqFile, method="curl")
}

library(data.table)
if (!exists("dTable")){
    # line 54 did not have two elements, fill should fix this for us
    csv <- read.csv(dataFile, header=TRUE, fill=TRUE)
    dTable <- data.table(csv)
}

#clean up. Temporarly turn off warnings about missing objects not found
options(warn=-1) 
rm(csv, dataDir, dataFile, dataFileZip, dateDownLoaded, docFile, faqFile, fileName, fileURL)
options(warn=0) 

```

## Question 1:
Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?


```{r use tables}
q1Data <- dTable[, list(EVTYPE, HARM = FATALITIES + INJURIES)]
q1AggregatedData <- q1Data[, list(TOTAL_HARM=sum(HARM)), by=EVTYPE]
q1OrderedData <- q1AggregatedData[order(TOTAL_HARM, decreasing=TRUE),]
nrow(q1OrderedData[TOTAL_HARM != 0])
```

```{r q1 graph}
library(ggplot2)

q1Graph <- qplot(
    y=TOTAL_HARM, x=EVTYPE, stat="identity", data=q1OrderedData[1:10,], 
    geom="bar", fill=factor(EVTYPE), 
    main="10 Most Harmfull Storm Types to Public Health")

q1Graph + theme(axis.text.x=element_blank())
q1OrderedData[1:10,]
```

## Question 2:
Across the United States, which types of events have the greatest economic consequences?

```{r q2 calculate total damage in dollars}

ltr  <- c("B" , "M" , "K", "")
multFactor <- c(10^9, 10^6, 10^3, 0)
damageData <- dTable[,
    list(EVTYPE,PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP,
         PROPDMGAMT=PROPDMG * multFactor[match(dTable$PROPDMGEXP,ltr)],
         CROPDMGAMT=CROPDMG * multFactor[match(dTable$CROPDMGEXP,ltr)]
         )
    ]
damageData$TOTAL_AMOUNT <- damageData[,PROPDMGAMT] + damageData[,CROPDMGAMT]
```

blah blah blah

```{r q2 aggregate by storm type}
#q1AggregatedData <-    q1Data[, list(TOTAL_HARM=sum(HARM                   )), by=EVTYPE]
q2AggregatedData <- damageData[, list(TOTAL_AMOUNT=sum(TOTAL_AMOUNT, na.rm=TRUE)), by=EVTYPE]
q2OrderedData <- q2AggregatedData[order(TOTAL_AMOUNT, decreasing=TRUE),]
```

blah blah blah

```{r question 2 graph}
q2Graph <- qplot(
    y=TOTAL_AMOUNT, x=EVTYPE, stat="identity", data=q2OrderedData[1:10,], 
    geom="bar", fill=factor(EVTYPE), 
    main="10 Most Economical Harmful Storm Types"
   )

q2Graph + theme(axis.text.x=element_blank()) +  ylab("damage amount in $")
```
